<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Generar Cotización PDF</title>
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
body {
  font-family: 'Segoe UI', sans-serif;
  background: #f9fafb;
  padding: 20px;
  margin: 0;
}

form {
  background: white;
  padding: 24px;
  border-radius: 16px;
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.05);
  max-width: 540px;
  margin: auto;
}

h2, h3 {
  margin-top: 0;
  color: #333;
}

label {
  display: block;
  margin: 16px 0 6px;
  font-weight: 600;
  color: #444;
}

input, select {
  width: 90%;
  padding: 12px 14px;
  border-radius: 12px;
  border: 1px solid #ccc;
  font-size: 16px;
  transition: border 0.2s ease, box-shadow 0.2s ease;
  background-color: #fff;
}

input:focus, select:focus {
  border-color: #007bff;
  box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
  outline: none;
}

.productos-container > div {
  border: 1px solid #ddd;
  padding: 14px;
  margin-top: 12px;
  border-radius: 12px;
  background: #fefefe;
}

button {
  width: 100%;
  padding: 14px;
  font-size: 16px;
  margin-top: 24px;
  border: none;
  border-radius: 12px;
  background: #007bff;
  color: white;
  cursor: pointer;
  transition: background 0.3s ease;
}

button:hover {
  background: #0056b3;
}

.add-producto {
  background: #28a745;
  margin-top: 10px;
}

.add-producto:hover {
  background: #218838;
}

@media (max-width: 480px) {
  form {
    padding: 20px;
    border-radius: 12px;
  }

  input, select, button {
    font-size: 16px;
  }

  label {
    margin-top: 12px;
  }
}
.productos-container {
  display: flex;
  flex-direction: column;
  gap: 12px;
  overflow-x: hidden;
}

.productos-container > div {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.productos-container input,
.productos-container select {
  max-width: 100%;
  box-sizing: border-box;
}
.producto {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
}

.producto label {
  flex: 1 1 100%;
}

.producto input {
  flex: 1 1 calc(33.333% - 8px);
  min-width: 0;
  box-sizing: border-box;
}

.remove-producto {
  background: #dc3545;
  color: #fff;
  border: none;
  padding: 10px;
  border-radius: 12px;
  cursor: pointer;
  margin-top: 8px;
  transition: background 0.3s ease;
  width: 100%;
}

.remove-producto:hover {
  background: #c82333;
}

.tab-wrapper {
      width: 100%;
      display: flex;
      justify-content: center;
    }

    ul {
      list-style: none;
      padding: 0;
      margin: 0 0 20px 0;
      display: flex;
      gap: 12px;
      border-bottom: 2px solid #dee2e6;
      max-width: 960px;
      width: 100%;
    }

    ul li a {
      display: inline-block;
      padding: 10px 18px;
      border-radius: 8px 8px 0 0;
      text-decoration: none;
      color: #495057;
      background: #f1f3f5;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    ul li a:hover {
      background: #e9ecef;
      color: #212529;
    }

    ul li a.active {
      background: #081f2c;
      color: #fff;
    }


  </style>
</head>
<body>

  <div class="tab-wrapper">
    <ul>
      <li><a class="cuentaCobro" href="index.html">Cuenta de Cobro</a></li>
      <li><a class="cotizacion" href="cotizacion.html">Cotizaciones</a></li>
    </ul>
  </div>

  <form id="cotizacionForm">
    <h2>Generar Cotización</h2>

    <label>Fecha</label>
    <input name="fecha" type="date" required>

    <hr>
    <h3>Empresa</h3>
    <label>Nombre</label>
    <input name="nombreEmpresa" required>

    <h3>Productos</h3>
    <div id="productos" class="productos-container">
      <div class="producto">
      <label>Cantidad</label>
      <input name="cantidad" type="number" required>
      <label>Concepto</label>
      <input name="concepto" required>
      <label>Valor</label>
      <input name="valor" type="number" required>
      <button type="button" class="remove-producto" onclick="eliminarProducto(this)">Eliminar</button>
    </div>

    </div>

    <button type="button" class="add-producto" onclick="agregarProducto()">Agregar otro producto</button>

    <button type="submit">Descargar Cotización</button>
  </form>

    <script>
  const path = window.location.pathname.replace('/', '').replace('.html', '') || 'index';

  document.querySelectorAll('ul li a').forEach(link => {
    if (link.classList.contains(path)) {
      link.classList.add('active');
    }
  });
</script>

  <script>
    // Set default date
    const hoy = new Date();
    const offset = hoy.getTimezoneOffset(); // en minutos
    hoy.setMinutes(hoy.getMinutes() - offset); // corrige desfase
    document.querySelector('input[name="fecha"]').value = hoy.toISOString().slice(0, 10);

    function agregarProducto() {
      const container = document.getElementById("productos");
      const div = document.createElement("div");
      div.classList.add("producto");
      div.innerHTML = `
        <label>Cantidad</label>
        <input name="cantidad" type="number" required>
        <label>Concepto</label>
        <input name="concepto" required>
        <label>Valor</label>
        <input name="valor" type="number" required>
        <button type="button" class="remove-producto" onclick="eliminarProducto(this)">Eliminar</button>
      `;
      container.appendChild(div);
    }

    function eliminarProducto(boton) {
      const productoDiv = boton.closest('.producto');
      productoDiv.remove();
    }

   document.getElementById('cotizacionForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(e.target);
      const [anio, mes, dia] = formData.get("fecha").split("-").map(Number);

      const meses = [
        "enero", "febrero", "marzo", "abril", "mayo", "junio",
        "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"
      ];

      const nombreMes = meses[mes - 1];

      const nombreEmpresa = formData.get("nombreEmpresa");
      const productos = [];
      const cantidadElems = document.querySelectorAll('input[name="cantidad"]');
      const conceptoElems = document.querySelectorAll('input[name="concepto"]');
      const valorElems = document.querySelectorAll('input[name="valor"]');

      for (let i = 0; i < cantidadElems.length; i++) {
        productos.push({
          cantidad: parseInt(cantidadElems[i].value),
          concepto: conceptoElems[i].value,
          valor: parseFloat(valorElems[i].value),
          subtotal: parseInt(cantidadElems[i].value) * parseFloat(valorElems[i].value),
        });
      }

      const subtotal = productos.reduce((sum, p) => sum + (p.valor * p.cantidad), 0);
      const total = subtotal;

      const response = await fetch("/.netlify/functions/get-cotizacion");
      const buffer = await response.arrayBuffer();
      const existingPdfBytes = new Uint8Array(buffer);
      const { PDFDocument, rgb } = PDFLib;
      const pdfDoc = await PDFDocument.load(existingPdfBytes);
      const page = pdfDoc.getPages()[0];

      const drawText = (text, x, y) => {
        page.drawText(String(text), { x, y, size: 10, color: rgb(0, 0, 0) });
      };

      // Fecha y consecutivo
      drawText(dia, 140, 660);
      drawText(nombreMes, 160, 660);
      drawText(anio, 190, 660);

      // Info empresa
      drawText(nombreEmpresa, 130, 595);
      // Productos (espaciados verticalmente)
      let yBase = 440;
      productos.forEach((p, i) => {
        drawText(p.cantidad, 100, yBase);
        drawText(p.concepto, 165, yBase);
        drawText(`$ ${p.valor.toLocaleString()}`, 400, yBase);
        drawText(`$ ${p.subtotal.toLocaleString()}`, 480, yBase);
        yBase -= 45;
      });
 
      drawText(`$ ${total.toLocaleString()}`, 480, 200);

      const pdfBytes = await pdfDoc.save();
      const blob = new Blob([pdfBytes], { type: 'application/pdf' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      const fechaStr = `${String(dia).padStart(2, '0')}${String(mes).padStart(2, '0')}${anio}`;
      const nombreLimpio = nombreEmpresa.trim().replace(/\s+/g, '_').replace(/[^\w\d_-]/g, '');
      const nombreArchivo = `Cotizacion-${fechaStr}-${nombreLimpio}.pdf`;

      link.download = nombreArchivo;

      link.click();
    });
  </script>
</body>
</html>
