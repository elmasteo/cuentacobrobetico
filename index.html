<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Generar Cotizaci贸n PDF</title>
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
    input, select { margin: 6px 0; padding: 5px; width: 100%; }
    button { padding: 10px 20px; background: #007bff; color: #fff; border: none; cursor: pointer; margin-top: 10px; }
    button:hover { background: #0056b3; }
    form { max-width: 400px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <form id="cotizacionForm">
    <h2>Generar Cotizaci贸n</h2>
    <label>D铆a <input name="dia" type="number" required></label>
    <label>Mes <input name="mes" type="number" required></label>
    <label>A帽o <input name="anio" type="number" required></label>
    <label>Consecutivo <input name="consecutivo" type="text" required></label>

    <hr>
    <h3>Empresa</h3>
    <label>Nombre <input name="nombreEmpresa" required></label>
    <label>
      Tipo identificaci贸n
      <select name="tipoId">
        <option value="cc">C.C. No</option>
        <option value="nit">NIT</option>
      </select>
    </label>
    <label>No Identificaci贸n <input name="identificacion" required></label>
    <label>Direcci贸n <input name="direccionEmpresa" required></label>
    <label>Tel茅fono <input name="telefonoEmpresa" required></label>
    <label>Ciudad <input name="ciudadEmpresa" required></label>
    <label>Cantidad <input name="cantidad" type="number" required></label>
    <label>Concepto <input name="concepto" required></label>
    <label>Valor <input name="valor" type="number" required></label>
    <label>Abono (opcional) <input name="abono" type="number"></label>

    <button type="submit">Descargar Cotizaci贸n</button>
  </form>

  <script>
    document.getElementById('cotizacionForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target));
      const abono = parseFloat(data.abono || 0);
      const valor = parseFloat(data.valor);
      const total = valor - abono;

      const response = await fetch("/.netlify/functions/get-pdf");
      const buffer = await response.arrayBuffer();
      const existingPdfBytes = new Uint8Array(buffer); //  m谩s directo

/*
      // Validar respuesta por si falla la funci贸n
      if (!base64.startsWith('JVBER')) {
        alert("Error: el archivo recibido no es un PDF v谩lido.");
        throw new Error("Respuesta inesperada: " + base64.slice(0, 50));
      }

      function base64ToUint8Array(base64) {
        const binaryString = atob(base64.replace(/\s/g, ''));
        const len = binaryString.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
          bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes;
      }

      const existingPdfBytes = base64ToUint8Array(base64);

*/

      const { PDFDocument, rgb } = PDFLib;
      const pdfDoc = await PDFDocument.load(existingPdfBytes);
      const page = pdfDoc.getPages()[0];

      const drawText = (text, x, y, mark = false) => {
        page.drawText(String(text), { x, y, size: 10, color: rgb(0, 0, 0) });
        if (mark) {
          page.drawRectangle({
            x,
            y,
            width: 5,
            height: 5,
            color: rgb(1, 0, 0),
          });
        }
      };


      // Posiciones ajustadas manualmente sobre el templatev2.pdf
      drawText(data.dia, 120, 950);  // true para mostrar marca
      drawText(data.mes, 165, 950);
      drawText(data.anio, 198, 950);
      drawText(data.consecutivo, 250, 950);

      // Info Empresa Comprador
      drawText(data.nombreEmpresa, 120, 750);
      drawText(data.identificacion, 500, 750);
      if (data.tipoId === 'cc') drawText('X', 400, 750);
      if (data.tipoId === 'nit') drawText('X', 435, 750);
      drawText(data.direccionEmpresa, 180, 713);
      drawText(data.telefonoEmpresa, 390, 713);
      drawText(data.ciudadEmpresa, 530, 713);

      // Cantidad - Concepto - Valor
      drawText(data.cantidad, 140, 600);
      drawText(data.concepto, 250, 600);
      drawText(`$ ${valor.toLocaleString()}`, 650, 600);
      if (abono) drawText(`$ ${abono.toLocaleString()}`, 650, 400);
      drawText(`$ ${valor.toLocaleString()}`, 680, 600);
      drawText(`$ ${total.toLocaleString()}`, 650, 350);

      const pdfBytes = await pdfDoc.save();
      const blob = new Blob([pdfBytes], { type: 'application/pdf' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'cotizacion.pdf';
      link.click();
    });
  </script>
</body>
</html>
